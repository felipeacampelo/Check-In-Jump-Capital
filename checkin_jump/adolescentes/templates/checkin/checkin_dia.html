{% extends 'adolescentes/base.html' %}
{% block content %}

<!-- Botão voltar -->
<div class="mb-3">
  <a href="{% url 'pagina_checkin' %}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i>Voltar
  </a>
</div>

<!-- Título e botão lado a lado -->
<div class="d-flex align-items-center justify-content-between mb-2">
  <div>
    <h2 class="mb-0">Check-in do dia {{ dia.data|date:"d/m/Y" }}</h2>
    {% if dia.titulo %}
      <p class="text-muted mb-0"><i class="fas fa-star me-1"></i>{{ dia.titulo }}</p>
    {% endif %}
  </div>
  <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalContagemAuditorio">
    <i class="fas fa-users me-1"></i>Contagem no Auditório
  </button>
</div>

<!-- Exibir última contagem registrada -->
{% with contagem=dia.contagens_auditorio.first %}
  {% if contagem %}
    <div class="alert alert-info">
      <i class="fas fa-users me-1"></i>
      <strong>Última contagem registrada:</strong> {{ contagem.quantidade_pessoas }} pessoas
      <br>
      <small>Registrado por {{ contagem.usuario_registro.username }} em {{ contagem.data_registro|date:"d/m/Y H:i" }}</small>
    </div>
  {% endif %}
{% endwith %}

<div class="row mb-3">
  <div class="col-md-8">
    <div class="btn-group" role="group">
      <a href="?filtro=todos{% if busca %}&busca={{ busca }}{% endif %}" class="btn btn-outline-primary {% if filtro == 'todos' %}active{% endif %}">Todos</a>
      <a href="?filtro=presentes{% if busca %}&busca={{ busca }}{% endif %}" class="btn btn-outline-success {% if filtro == 'presentes' %}active{% endif %}">Somente Presentes</a>
      <a href="?filtro=ausentes{% if busca %}&busca={{ busca }}{% endif %}" class="btn btn-outline-secondary {% if filtro == 'ausentes' %}active{% endif %}">Somente Ausentes</a>
    </div>
  </div>
  <div class="col-md-4">
    <form method="get" class="d-flex">
      <input type="hidden" name="filtro" value="{{ filtro }}">
      <input type="text" name="busca" value="{{ busca }}" class="form-control me-2" placeholder="Buscar adolescente...">
      <button type="submit" class="btn btn-outline-primary">
        <i class="fas fa-search"></i>
      </button>
    </form>
  </div>
</div>

{% if busca %}
  <div class="alert alert-info">
    <i class="fas fa-search me-1"></i>Buscando por: "{{ busca }}"
    <a href="?filtro={{ filtro }}" class="btn btn-sm btn-outline-secondary ms-2">Limpar busca</a>
  </div>
{% endif %}

<form method="post">
  {% csrf_token %}
  <ul class="list-group mb-3">
    {% for adolescente in adolescentes %}
      <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
          <label class="form-check-label d-flex align-items-center">
            <input type="checkbox" 
                   class="form-check-input me-2 presenca-checkbox"
                   data-adolescente-id="{{ adolescente.id }}"
                   {% if adolescente.id in presentes_ids %}checked{% endif %}>
            {{ adolescente.nome }} {{ adolescente.sobrenome }}
          </label>
          <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal{{ adolescente.id }}">
            <i class="fas fa-eye me-1"></i>Ver detalhes
          </button>
        </div>
      </li>

      <!-- Modal do Adolescente -->
      <div class="modal fade" id="modal{{ adolescente.id }}" tabindex="-1" aria-labelledby="modalLabel{{ adolescente.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalLabel{{ adolescente.id }}">Detalhes de {{ adolescente.nome }} {{ adolescente.sobrenome }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
              <p><strong>Nome Completo:</strong> {{ adolescente.nome }} {{ adolescente.sobrenome }}</p>
              <p><strong>Gênero:</strong> {{ adolescente.get_genero_display }}</p>
              <p><strong>Data de Nascimento:</strong> {{ adolescente.data_nascimento|date:"d/m/Y" }}</p>
              <p><strong>Pequeno Grupo (PG):</strong> {{ adolescente.pg }}</p>
              <p><strong>Império:</strong> {{ adolescente.imperio }}</p>
              {% if adolescente.foto %}
                <p><strong>Foto:</strong></p>
                <img src="{{ adolescente.foto.url }}" class="img-fluid" alt="Foto de {{ adolescente.nome }}">
              {% endif %}

              <hr>
              <h6>Histórico de Presenças:</h6>
              <ul class="list-group">
                {% for presenca in adolescente.ultimas_presencas %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ presenca.dia.data|date:"d/m/Y" }}
                    {% if presenca.presente %}
                      <span class="badge bg-success">Presente</span>
                    {% else %}
                      <span class="badge bg-danger">Ausente</span>
                    {% endif %}
                  </li>
                {% empty %}
                  <li class="list-group-item">Nenhum registro de presença.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </ul>
</form>

<!-- Paginação -->
{% if adolescentes.has_other_pages %}
  <nav aria-label="Paginação de adolescentes">
    <ul class="pagination justify-content-center">
      {% if adolescentes.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1&filtro={{ filtro }}{% if busca %}&busca={{ busca }}{% endif %}">
            <i class="fas fa-angle-double-left"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ adolescentes.previous_page_number }}&filtro={{ filtro }}{% if busca %}&busca={{ busca }}{% endif %}">
            <i class="fas fa-angle-left"></i>
          </a>
        </li>
      {% endif %}

      {% for num in adolescentes.paginator.page_range %}
        {% if adolescentes.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > adolescentes.number|add:'-3' and num < adolescentes.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}&filtro={{ filtro }}{% if busca %}&busca={{ busca }}{% endif %}">{{ num }}</a>
          </li>
        {% endif %}
      {% endfor %}

      {% if adolescentes.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ adolescentes.next_page_number }}&filtro={{ filtro }}{% if busca %}&busca={{ busca }}{% endif %}">
            <i class="fas fa-angle-right"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ adolescentes.paginator.num_pages }}&filtro={{ filtro }}{% if busca %}&busca={{ busca }}{% endif %}">
            <i class="fas fa-angle-double-right"></i>
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
  
  <div class="text-center text-muted">
    <small>
      Página {{ adolescentes.number }} de {{ adolescentes.paginator.num_pages }} 
      ({{ adolescentes.paginator.count }} adolescentes no total)
    </small>
  </div>
{% endif %}

<!-- Modal de contagem de auditório -->
<div class="modal fade" id="modalContagemAuditorio" tabindex="-1" aria-labelledby="modalContagemAuditorioLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="contagem_auditorio" value="1">
        <input type="hidden" name="dia" value="{{ dia.id }}">
        <div class="modal-header">
          <h5 class="modal-title" id="modalContagemAuditorioLabel"><i class="fas fa-users me-1"></i>Contagem no Auditório</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="quantidade_pessoas" class="form-label">Quantidade de Pessoas</label>
            <input type="number" class="form-control" id="quantidade_pessoas" name="quantidade_pessoas" min="1" placeholder="Ex: 190" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Contagem</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Função para pegar o CSRF token do cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const diaId = parseInt('{{ dia.id|escapejs }}');
    
    // Atualizar presença automaticamente ao marcar checkbox
    document.querySelectorAll('.presenca-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function(event) {
        const adolescenteId = parseInt(event.target.dataset.adolescenteId);
        const presente = event.target.checked;
        
        event.target.disabled = true;
        
        fetch("{% url 'atualizar_presenca' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({
            adolescente_id: adolescenteId,
            dia_id: diaId,
            presente: presente
          })
        })
        .then(function(response) {
          if (!response.ok) {
            if (response.status === 403) {
              alert('Erro de permissão. Verifique se você tem autorização.');
            } else if (response.status === 404) {
              alert('Recurso não encontrado.');
            } else {
              alert('Erro ao salvar presença (status: ' + response.status + ')');
            }
            event.target.checked = !presente;
            throw new Error('Response not ok');
          }
          return response.json();
        })
        .then(function(data) {
          console.log('Presença atualizada com sucesso');
        })
        .catch(function(error) {
          console.error('Erro:', error);
          if (error.message !== 'Response not ok') {
            alert('Erro de rede ao salvar presença');
            event.target.checked = !presente;
          }
        })
        .finally(function() {
          event.target.disabled = false;
        });
      });
    });

  });
</script>

{% endblock %}
