{% extends 'adolescentes/base.html' %}
{% load static %}

{% block extra_head %}
  <link rel="preload" as="image" href="{% static 'adolescentes/img/login-bg.jpg' %}">
{% endblock %}

{% block body_class %}d-flex flex-column min-vh-100{% endblock %}

{% block content %}
<style>
  html, body { height: 100%; background: #0b1320; }
  body { margin: 0; padding-top: 0 !important; }
  html, body { overflow-x: hidden; }
  /* Make base container full-bleed on this page */
  main > .container { max-width: 100% !important; padding-left: 0 !important; padding-right: 0 !important; }
  .login-hero {
    position: relative;
    height: 100vh;
    width: 100vw;                 /* full viewport width */
    left: 50%;                    /* breakout from any parent container */
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    color: #fff;
  }
  .login-hero::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.55)),
                url("{% static 'adolescentes/img/login-bg.jpg' %}") center/cover no-repeat;
    filter: saturate(110%);
    z-index: 0;
  }
  .login-grid { position: relative; z-index: 1; width: 100%; }
  .welcome-panel {
    position: relative;
    color: #fff;
    padding: 3rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    overflow: hidden;
  }
  /* Align the logo's left edge with the content start; keep a small minimum gutter */
  .top-left-logo { position: absolute; top: -36px; left: max(16px, calc(50% - 340px)); }
  .brand-logo-top { display: block; height: auto; width: auto; max-width: 240px; }
  .welcome-panel h1 { font-weight: 800; letter-spacing: .3px; white-space: nowrap; }
  /* Keep a common content width so the paragraph left edge matches the title block */
  .welcome-content { width: min(92%, 680px); margin: 0 auto; }
  .welcome-panel p { max-width: 100%; font-size: 1rem; opacity: .9; text-align: left; }
  /* Mobile logo above card */
  .mobile-logo-wrap { margin-bottom: .5rem; margin-top: -8px; }
  .mobile-logo-img { display: inline-block; height: auto; width: auto; max-width: clamp(260px, 70vw, 420px); }
  @media (max-width: 991.98px) { /* < lg */
    .mobile-logo-wrap { position: fixed; top: 56px; left: 50%; transform: translateX(-50%); z-index: 2; margin: 0; }
    .right-pane { padding-top: 60px !important; }
  }
  .welcome-badge { backdrop-filter: blur(6px); background: rgba(255,255,255,0.12); border-radius: 999px; padding: .25rem .75rem; display: inline-flex; align-items: center; gap: .5rem; }
  .welcome-badge i { color: #ffd166; }
  .login-card {
    z-index: 1;
    width: 100%;
    max-width: 400px;
    background: #ffffff;
    border: none;
    border-radius: 16px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.35);
    overflow: hidden;
  }
  .login-card .card-header {
    background: transparent;
    border-bottom: none;
    text-align: center;
    padding: 1.5rem 1.5rem 0.5rem;
  }
  .brand-title {
    font-weight: 700;
    font-size: 1.25rem;
    color: #0d6efd;
    letter-spacing: 0.3px;
  }
  /* Logos: preserve aspect ratio and prevent squashing */
  .brand-logo { display: block; height: auto; width: auto; max-width: clamp(200px, 22vw, 380px); }
  .brand-logo-lg { display: block; height: auto; width: auto; max-width: clamp(280px, 32vw, 600px); }
  .login-card .card-body {
    padding: 1.5rem;
  }
  .form-floating>.form-control { height: calc(3.5rem + 2px); }
  .muted-links { font-size: .9rem; }
  .muted-links a { text-decoration: none; }
  .alert-login { border-radius: 10px; }
  @media (min-width: 992px) {
    .right-pane { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
  }
  .login-copy { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); color: #ffffff; opacity: .85; font-size: .9rem; z-index: 2; }
  /* Ensure modal appears above hero/backdrop stacking contexts */
  .modal { z-index: 2000; }
  .modal-backdrop { z-index: 1990; }
</style>

{# Esconde a navbar no login sobrescrevendo o bloco definido no base.html #}
{% block navbar %}{% endblock %}

<section class="login-hero">
  <div class="login-grid container-fluid px-0">
    <div class="row g-0">
      <div class="col-lg-7 d-none d-lg-flex">
        <div class="welcome-panel">
          <div class="top-left-logo">
            <img src="{% static 'adolescentes/img/logo-white.png' %}" alt="Logo" class="brand-logo-top" />
          </div>

          <div class="welcome-content">
            <h1 class="display-5 mb-3 text-center">Bem-vindo ao Check-in Jump</h1>
            <p>Gerencie adolescentes, presenças, veja relatórios e muito mais. Faça login para começar.</p>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5 right-pane p-4 p-lg-5">
        <div class="d-lg-none text-center mobile-logo-wrap">
          <img src="{% static 'adolescentes/img/logo-white.png' %}" alt="Logo" class="mobile-logo-img" />
        </div>
        <div class="mx-auto login-card card">
          <div class="card-header">
            <h2 class="h5 text-dark mt-2 mb-0">Acesse sua conta</h2>
          </div>
          <div class="card-body">
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-danger alert-login mb-3" role="alert">{{ message }}</div>
              {% endfor %}
            {% endif %}
            <form method="post" novalidate>
              {% csrf_token %}
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="username" name="username" placeholder="Usuário" required>
                <label for="username">Usuário</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" name="password" placeholder="Senha" required>
                <label for="password">Senha</label>
              </div>
              <button type="submit" class="btn btn-primary w-100 py-2">Entrar</button>
            </form>
            <div class="d-flex justify-content-between align-items-center mt-3 muted-links">
              <span class="text-muted">Problemas para entrar?</span>
              <a id="whatsBtn" href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#whatsModal">Contatar o administrador</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="login-copy">© 2025 JUMP Capital</div>
{# Modal global para WhatsApp - dentro do bloco content, mas fora do hero, para evitar problemas de stacking #}
<div class="modal fade" id="whatsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">Informar usuário</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <label for="whatsUsername" class="form-label small text-muted">Seu usuário</label>
        <input type="text" id="whatsUsername" class="form-control" placeholder="Digite seu usuário">
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="whatsConfirm" class="btn btn-success btn-sm">Enviar no WhatsApp</button>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const btn = document.getElementById('whatsBtn');
    const modalEl = document.getElementById('whatsModal');
    const inputEl = document.getElementById('whatsUsername');
    const confirmBtn = document.getElementById('whatsConfirm');
    const closeBtn = modalEl ? modalEl.querySelector('[data-bs-dismiss="modal"]') : null;
    if (!btn || !modalEl || !inputEl || !confirmBtn) return;
    const phone = '5561995030469';

    function getPreFill(){
      const uInput = document.querySelector('input[name="username"], #username');
      return (uInput && uInput.value ? uInput.value.trim() : '') || '';
    }
    function buildUrl(u){
      const user = (u && u.trim()) ? u.trim() : '(não informado)';
      const msg = `Olá, preciso de um link para redefinir minha senha. Meu usuário: ${user}.`;
      return `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    }

    // Bootstrap path
    function bootstrapShow(){
      const inst = bootstrap.Modal.getOrCreateInstance(modalEl);
      inputEl.value = getPreFill();
      inst.show();
      setTimeout(()=> inputEl.focus(), 120);
    }
    function bootstrapHide(){
      const inst = bootstrap.Modal.getInstance(modalEl);
      if (inst) inst.hide();
    }

    // Fallback (sem Bootstrap JS)
    let fbBackdrop = null;
    function fallbackShow(){
      inputEl.value = getPreFill();
      modalEl.style.display = 'block';
      modalEl.removeAttribute('aria-hidden');
      modalEl.classList.add('show');
      document.body.classList.add('modal-open');
      fbBackdrop = document.createElement('div');
      fbBackdrop.className = 'modal-backdrop fade show';
      fbBackdrop.style.zIndex = 1990;
      document.body.appendChild(fbBackdrop);
      setTimeout(()=> inputEl.focus(), 120);
    }
    function fallbackHide(){
      modalEl.classList.remove('show');
      modalEl.setAttribute('aria-hidden','true');
      modalEl.style.display = 'none';
      document.body.classList.remove('modal-open');
      if (fbBackdrop && fbBackdrop.parentNode) fbBackdrop.parentNode.removeChild(fbBackdrop);
      fbBackdrop = null;
    }

    // Open modal
    btn.addEventListener('click', function(e){
      e.preventDefault();
      if (window.bootstrap && bootstrap.Modal) {
        bootstrapShow();
      } else {
        fallbackShow();
      }
    });

    // Prefill with Bootstrap event too (no-op in fallback)
    modalEl.addEventListener('show.bs.modal', function(){
      inputEl.value = getPreFill();
      setTimeout(()=> inputEl.focus(), 120);
    });

    // Confirm -> open WhatsApp and close modal
    confirmBtn.addEventListener('click', function(){
      const url = buildUrl(inputEl.value);
      window.open(url, '_blank', 'noopener');
      if (window.bootstrap && bootstrap.Modal) bootstrapHide(); else fallbackHide();
    });

    // Close button in fallback
    if (closeBtn) {
      closeBtn.addEventListener('click', function(){
        if (!(window.bootstrap && bootstrap.Modal)) fallbackHide();
      });
    }

    // Enter submits
    inputEl.addEventListener('keydown', function(ev){
      if (ev.key === 'Enter') { ev.preventDefault(); confirmBtn.click(); }
    });
  })();
</script>

{% endblock %}

{% block footer %}{% endblock %}
