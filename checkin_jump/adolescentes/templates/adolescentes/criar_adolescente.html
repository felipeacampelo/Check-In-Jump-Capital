{% extends 'adolescentes/base.html' %}

{% block content %}
  <h2>Cadastrar Adolescente</h2>

  {% if dia_checkin %}
    <div class="alert alert-info">
      <i class="fas fa-calendar-check me-2"></i>
      <strong>Check-in Automático:</strong> Este adolescente será automaticamente marcado como presente no evento de <strong>{{ dia_checkin.data|date:"d/m/Y" }}</strong>
      {% if dia_checkin.titulo %}
        - {{ dia_checkin.titulo }}
      {% endif %}
    </div>
  {% elif evento_hoje %}
    <div class="alert alert-info">
      <i class="fas fa-calendar-check me-2"></i>
      <strong>Check-in Automático:</strong> Existe um evento hoje (<strong>{{ evento_hoje }}</strong>). O adolescente será marcado como presente automaticamente.
    </div>
  {% endif %}

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="POST" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}
    
    <!-- Dados Pessoais -->
    <div class="card mb-3">
      <div class="card-header"><i class="fas fa-user me-2"></i>Dados Pessoais</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="id_nome" class="form-label">Nome *</label>
            {{ form.nome }}
            {% if form.nome.errors %}<div class="text-danger small">{{ form.nome.errors.0 }}</div>{% endif %}
          </div>
          <div class="col-md-6">
            <label for="id_sobrenome" class="form-label">Sobrenome *</label>
            {{ form.sobrenome }}
            {% if form.sobrenome.errors %}<div class="text-danger small">{{ form.sobrenome.errors.0 }}</div>{% endif %}
          </div>
          <div class="col-md-4">
            <label for="id_data_nascimento" class="form-label">Data de Nascimento *</label>
            {{ form.data_nascimento }}
            {% if form.data_nascimento.errors %}<div class="text-danger small">{{ form.data_nascimento.errors.0 }}</div>{% endif %}
            <div id="aviso-idade" class="mt-1"></div>
          </div>
          <div class="col-md-4">
            <label for="id_genero" class="form-label">Sexo *</label>
            {{ form.genero }}
          </div>
          <div class="col-md-4">
            <label for="id_telefone" class="form-label">Telefone</label>
            {{ form.telefone }}
          </div>
          <div class="col-md-6">
            <label for="id_foto" class="form-label">Foto</label>
            {{ form.foto }}
          </div>
        </div>
      </div>
    </div>

    <!-- Responsável -->
    <div class="card mb-3">
      <div class="card-header"><i class="fas fa-user-shield me-2"></i>Responsável</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="id_nome_responsavel" class="form-label">Nome do Responsável</label>
            {{ form.nome_responsavel }}
          </div>
          <div class="col-md-6">
            <label for="id_telefone_responsavel" class="form-label">Telefone do Responsável</label>
            {{ form.telefone_responsavel }}
          </div>
        </div>
      </div>
    </div>

    <!-- PG e Império -->
    <div class="card mb-3">
      <div class="card-header"><i class="fas fa-users me-2"></i>PG e Império</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="id_pg" class="form-label">PG</label>
            {{ form.pg }}
          </div>
          <div class="col-md-6">
            <label for="id_imperio" class="form-label">Império</label>
            {{ form.imperio }}
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-success"><i class="fas fa-save me-1"></i>Salvar</button>
      <a href="{% url 'listar_adolescentes' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Procura o input de data de nascimento
      var dataInput = document.querySelector('input[name="data_nascimento"]');
      var aviso = document.getElementById('aviso-idade');
      if (dataInput && aviso) {
        // Função para calcular idade
        function calcularIdade(dataStr) {
          if (!dataStr) return null;
          var partes = dataStr.split('-');
          if (partes.length === 3) {
            // yyyy-mm-dd
            var ano = parseInt(partes[0]);
            var mes = parseInt(partes[1]) - 1;
            var dia = parseInt(partes[2]);
          } else {
            partes = dataStr.split('/');
            if (partes.length !== 3) return null;
            // dd/mm/yyyy
            var dia = parseInt(partes[0]);
            var mes = parseInt(partes[1]) - 1;
            var ano = parseInt(partes[2]);
          }
          var hoje = new Date();
          var nascimento = new Date(ano, mes, dia);
          var idade = hoje.getFullYear() - nascimento.getFullYear();
          var m = hoje.getMonth() - nascimento.getMonth();
          if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) {
            idade--;
          }
          return idade;
        }
        // Função para mostrar aviso
        function mostrarAviso() {
          var valor = dataInput.value;
          if (!valor || valor.length < 10) {
            aviso.innerHTML = '';
            return;
          }
          var idade = calcularIdade(valor);
          if (idade === null || isNaN(idade)) {
            aviso.innerHTML = '';
            return;
          }
          if (idade < 12) {
            aviso.innerHTML = '<span class="text-warning fw-bold">Atenção: Menor de 12 anos (' + idade + ' anos)</span>';
          } else if (idade > 18) {
            aviso.innerHTML = '<span class="text-danger fw-bold">Atenção: Maior de 18 anos (' + idade + ' anos)</span>';
          } else {
            aviso.innerHTML = '';
          }
        }
        dataInput.addEventListener('input', mostrarAviso);
        dataInput.addEventListener('change', mostrarAviso);
        // Chama ao carregar
        mostrarAviso();
      }

    });
  </script>
{% endblock %}