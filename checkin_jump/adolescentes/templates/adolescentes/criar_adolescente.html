{% extends 'adolescentes/base.html' %}

{% block content %}
  <h2>Cadastrar Adolescente</h2>

  {% if dia_checkin %}
    <div class="alert alert-info">
      <i class="fas fa-calendar-check me-2"></i>
      <strong>Check-in Automático:</strong> Este adolescente será automaticamente marcado como presente no evento de <strong>{{ dia_checkin.data|date:"d/m/Y" }}</strong>
      {% if dia_checkin.titulo %}
        - {{ dia_checkin.titulo }}
      {% endif %}
    </div>
  {% elif evento_hoje %}
    <div class="alert alert-info">
      <i class="fas fa-calendar-check me-2"></i>
      <strong>Check-in Automático:</strong> Existe um evento hoje (<strong>{{ evento_hoje }}</strong>). O adolescente será marcado como presente automaticamente.
    </div>
  {% endif %}

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="POST" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}
    
    <!-- Dados Pessoais -->
    <div class="card mb-3">
      <div class="card-header"><i class="fas fa-user me-2"></i>Dados Pessoais</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="id_nome" class="form-label">Nome *</label>
            {{ form.nome }}
            {% if form.nome.errors %}<div class="text-danger small">{{ form.nome.errors.0 }}</div>{% endif %}
          </div>
          <div class="col-md-6">
            <label for="id_sobrenome" class="form-label">Sobrenome *</label>
            {{ form.sobrenome }}
            {% if form.sobrenome.errors %}<div class="text-danger small">{{ form.sobrenome.errors.0 }}</div>{% endif %}
          </div>
          <div class="col-md-4">
            <label for="id_data_nascimento" class="form-label">Data de Nascimento *</label>
            {{ form.data_nascimento }}
            {% if form.data_nascimento.errors %}<div class="text-danger small">{{ form.data_nascimento.errors.0 }}</div>{% endif %}
            <div id="aviso-idade" class="mt-1"></div>
          </div>
          <div class="col-md-4">
            <label for="id_genero" class="form-label">Sexo *</label>
            {{ form.genero }}
          </div>
          <div class="col-md-4">
            <label for="id_telefone" class="form-label">Telefone</label>
            {{ form.telefone }}
          </div>
          <div class="col-md-6">
            <label for="id_foto" class="form-label">Foto</label>
            {{ form.foto }}
          </div>
        </div>
      </div>
    </div>

    <!-- Responsável -->
    <div class="card mb-3">
      <div class="card-header"><i class="fas fa-user-shield me-2"></i>Responsável</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="id_nome_responsavel" class="form-label">Nome do Responsável</label>
            {{ form.nome_responsavel }}
          </div>
          <div class="col-md-6">
            <label for="id_telefone_responsavel" class="form-label">Telefone do Responsável</label>
            {{ form.telefone_responsavel }}
          </div>
        </div>
      </div>
    </div>

    <!-- PG e Império -->
    <div class="card mb-3">
      <div class="card-header"><i class="fas fa-users me-2"></i>PG e Império</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="id_pg" class="form-label">PG</label>
            {{ form.pg }}
          </div>
          <div class="col-md-6">
            <label for="id_imperio" class="form-label">Império</label>
            {{ form.imperio }}
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-success"><i class="fas fa-save me-1"></i>Salvar</button>
      <a href="{% url 'listar_adolescentes' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Procura o input de data de nascimento
      var dataInput = document.querySelector('input[name="data_nascimento"]');
      var aviso = document.getElementById('aviso-idade');
      if (dataInput && aviso) {
        // Função para calcular idade
        function calcularIdade(dataStr) {
          if (!dataStr) return null;
          var partes = dataStr.split('-');
          if (partes.length === 3) {
            // yyyy-mm-dd
            var ano = parseInt(partes[0]);
            var mes = parseInt(partes[1]) - 1;
            var dia = parseInt(partes[2]);
          } else {
            partes = dataStr.split('/');
            if (partes.length !== 3) return null;
            // dd/mm/yyyy
            var dia = parseInt(partes[0]);
            var mes = parseInt(partes[1]) - 1;
            var ano = parseInt(partes[2]);
          }
          var hoje = new Date();
          var nascimento = new Date(ano, mes, dia);
          var idade = hoje.getFullYear() - nascimento.getFullYear();
          var m = hoje.getMonth() - nascimento.getMonth();
          if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) {
            idade--;
          }
          return idade;
        }
        // Função para mostrar aviso
        function mostrarAviso() {
          var valor = dataInput.value;
          if (!valor || valor.length < 10) {
            aviso.innerHTML = '';
            return;
          }
          var idade = calcularIdade(valor);
          if (idade === null || isNaN(idade)) {
            aviso.innerHTML = '';
            return;
          }
          if (idade < 12) {
            aviso.innerHTML = '<span class="text-warning fw-bold">Atenção: Menor de 12 anos (' + idade + ' anos)</span>';
          } else if (idade > 18) {
            aviso.innerHTML = '<span class="text-danger fw-bold">Atenção: Maior de 18 anos (' + idade + ' anos)</span>';
          } else {
            aviso.innerHTML = '';
          }
        }
        dataInput.addEventListener('input', mostrarAviso);
        dataInput.addEventListener('change', mostrarAviso);
        // Chama ao carregar
        mostrarAviso();
      }

      // --- Câmera ---
      var btnCamera = document.getElementById('btnCamera');
      var btnCapturar = document.getElementById('btnCapturar');
      var video = document.getElementById('cameraVideo');
      var canvas = document.getElementById('cameraCanvas');
      var cameraSelect = document.getElementById('cameraSelect');
      var inputFotoFile = document.getElementById('inputFotoFile');
      var inputFotoHidden = document.getElementById('inputFotoHidden');
      var fotoPreview = document.getElementById('fotoPreview');
      var fotoPreviewWrapper = document.getElementById('fotoPreviewWrapper');
      var btnRemoverFoto = document.getElementById('btnRemoverFoto');
      var cameraModal = document.getElementById('cameraModal');
      var currentStream = null;

      function showPreview(src) {
        fotoPreview.src = src;
        fotoPreviewWrapper.classList.remove('d-none');
      }

      function clearPreview() {
        fotoPreviewWrapper.classList.add('d-none');
        fotoPreview.src = '';
        inputFotoFile.value = '';
        inputFotoFile.name = 'foto';
        inputFotoHidden.name = '';
        var dt = new DataTransfer();
        inputFotoHidden.files = dt.files;
      }

      if (btnRemoverFoto) btnRemoverFoto.addEventListener('click', clearPreview);

      // Upload de arquivo: mostrar preview
      if (inputFotoFile) {
        inputFotoFile.addEventListener('change', function() {
          if (this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) { showPreview(e.target.result); };
            reader.readAsDataURL(this.files[0]);
            // Usar file input, desativar hidden
            inputFotoFile.name = 'foto';
            inputFotoHidden.name = '';
            var dt = new DataTransfer();
            inputFotoHidden.files = dt.files;
          }
        });
      }

      function stopCamera() {
        if (currentStream) {
          currentStream.getTracks().forEach(function(t) { t.stop(); });
          currentStream = null;
        }
      }

      function startCamera(deviceId) {
        stopCamera();
        var constraints = { video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'user' } };
        navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
          currentStream = stream;
          video.srcObject = stream;
        }).catch(function(err) {
          alert('Não foi possível acessar a câmera: ' + err.message);
        });
      }

      function loadCameras() {
        navigator.mediaDevices.enumerateDevices().then(function(devices) {
          var cameras = devices.filter(function(d) { return d.kind === 'videoinput'; });
          cameraSelect.innerHTML = '';
          if (cameras.length === 0) {
            cameraSelect.innerHTML = '<option value="">Nenhuma câmera encontrada</option>';
            return;
          }
          cameras.forEach(function(cam, i) {
            var opt = document.createElement('option');
            opt.value = cam.deviceId;
            opt.textContent = cam.label || ('Câmera ' + (i + 1));
            cameraSelect.appendChild(opt);
          });
        });
      }

      if (cameraSelect) {
        cameraSelect.addEventListener('change', function() {
          if (this.value) startCamera(this.value);
        });
      }

      if (btnCamera) {
        btnCamera.addEventListener('click', function() {
          var modal = new bootstrap.Modal(cameraModal);
          modal.show();
          startCamera();
          loadCameras();
        });
      }

      if (cameraModal) {
        cameraModal.addEventListener('hidden.bs.modal', function() {
          stopCamera();
        });
      }

      if (btnCapturar) {
        btnCapturar.addEventListener('click', function() {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video, 0, 0);
          canvas.toBlob(function(blob) {
            // Colocar blob no hidden file input
            var file = new File([blob], 'camera-foto.jpg', { type: 'image/jpeg' });
            var dt = new DataTransfer();
            dt.items.add(file);
            inputFotoHidden.files = dt.files;
            // Usar hidden, desativar file input
            inputFotoHidden.name = 'foto';
            inputFotoFile.name = '';
            inputFotoFile.value = '';
            // Mostrar preview
            showPreview(canvas.toDataURL('image/jpeg', 0.85));
            // Fechar modal
            bootstrap.Modal.getInstance(cameraModal).hide();
          }, 'image/jpeg', 0.85);
        });
      }
    });
  </script>
{% endblock %}